<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Logs</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; }
        h1 { margin-bottom: 20px; color: #58a6ff; }
        .controls { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        button { padding: 8px 16px; background: #238636; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        button:hover { background: #2ea043; }
        button:active { background: #2c974b; }
        .clear-btn { background: #da3633; }
        .clear-btn:hover { background: #f85149; }
        #logContainer { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 15px; max-height: calc(100vh - 150px); overflow-y: auto; font-family: "Consolas", "Monaco", monospace; font-size: 13px; line-height: 1.8; }
        .log-entry { padding: 6px 0; border-bottom: 1px solid #21262d; display: flex; gap: 12px; }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #6e7681; min-width: 90px; flex-shrink: 0; }
        .log-level { min-width: 70px; flex-shrink: 0; font-weight: bold; }
        .log-message { flex: 1; word-break: break-word; }
        .log-INFO { color: #58a6ff; }
        .log-WARNING { color: #d29922; }
        .log-ERROR { color: #f85149; }
        .log-DEBUG { color: #8b949e; }
        .auto-scroll-label { display: flex; align-items: center; gap: 5px; font-size: 14px; }
        input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .copy-btn { background: #1f6feb; }
        .copy-btn:hover { background: #388bfd; }
    </style>
</head>
<body>
    <h1>Proxy Logs</h1>
    
    <div class="controls">
        <button onclick="window.location.href='/dashboard'">Back to Dashboard</button>
        <button class="copy-btn" onclick="copyLogs()">Copy All</button>
        <button class="clear-btn" onclick="clearDisplay()">Clear Display</button>
        <label class="auto-scroll-label">
            <input type="checkbox" id="autoScroll" checked>
            Auto-scroll
        </label>
    </div>
    
    <div id="logContainer"></div>
    
    <script>
        let autoScroll = true;
        let displayedLogs = [];
        
        document.getElementById('autoScroll').addEventListener('change', (e) => {
            autoScroll = e.target.checked;
        });
        
        function fetchLogs() {
            fetch('/logs')
                .then(response => response.json())
                .then(data => {
                    displayedLogs = data.logs || [];
                    renderLogs();
                })
                .catch(error => console.error('Error fetching logs:', error));
        }
        
        function renderLogs() {
            const container = document.getElementById('logContainer');
            const wasAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;
            
            if (displayedLogs.length === 0) {
                container.innerHTML = '<div style="color: #6e7681; text-align: center; padding: 20px;">No logs to display</div>';
                return;
            }
            
            container.innerHTML = displayedLogs.map(log => {
                let level = 'INFO';
                let text = '';
                let timestamp = '';
                
                if (typeof log === 'object' && log.message) {
                    level = log.level || 'INFO';
                    text = log.message;
                    timestamp = new Date(log.timestamp).toLocaleTimeString();
                } else if (typeof log === 'string') {
                    text = log;
                    timestamp = new Date().toLocaleTimeString();
                    if (log.includes('ERROR')) level = 'ERROR';
                    else if (log.includes('WARNING')) level = 'WARNING';
                    else if (log.includes('DEBUG')) level = 'DEBUG';
                } else {
                    text = String(log);
                    timestamp = new Date().toLocaleTimeString();
                }
                
                const escapedText = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                const levelColors = {
                    'INFO': '#58a6ff',
                    'WARNING': '#d29922',
                    'ERROR': '#f85149',
                    'DEBUG': '#8b949e'
                };
                const levelColor = levelColors[level] || '#58a6ff';
                
                return `<div class="log-entry">
                    <span class="log-time">${timestamp}</span>
                    <span class="log-level" style="color: ${levelColor}">[${level}]</span>
                    <span class="log-message">${escapedText}</span>
                </div>`;
            }).join('');
            
            if (autoScroll && wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function clearDisplay() {
            // Clear server-side logs
            fetch('/logs/clear', { method: 'POST' })
                .then(() => {
                    displayedLogs = [];
                    renderLogs();
                })
                .catch(err => {
                    console.error('Failed to clear logs:', err);
                    // Still clear display even if server clear fails
                    displayedLogs = [];
                    renderLogs();
                });
        }
        
        function copyLogs() {
            const text = displayedLogs.map(log => {
                if (typeof log === 'object' && log.message) {
                    return `${log.timestamp} [${log.level}] ${log.message}`;
                } else if (typeof log === 'string') {
                    return log;
                } else {
                    return String(log);
                }
            }).join('\n');
            navigator.clipboard.writeText(text)
                .then(() => alert('Logs copied to clipboard!'))
                .catch(err => alert('Failed to copy logs'));
        }
        
        fetchLogs();
        setInterval(fetchLogs, 3000);
    </script>
</body>
</html>
