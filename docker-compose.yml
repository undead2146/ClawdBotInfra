# ============================================================
# Claude Stack - Docker Compose Configuration
# ============================================================
# This orchestrates:
# - proxy: Python-based ClaudeProxy router with dashboard
# - clawdbot: Claude Code agent/worker
# - scheduler: Docker-native cron (Ofelia)
# ============================================================

services:
  # ============================================
  # CLAUDE PROXY (Python-based Multi-Provider Router)
  # ============================================
  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    container_name: claude-proxy
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      - PORT=8082
      - HAIKU_PROVIDER=glm
      - SONNET_PROVIDER=glm
      - HAIKU_PROVIDER_API_KEY=f588d31a2a6f4869a0297509da6d42ab.YwwL3W8HRUxLNjIk
      - HAIKU_PROVIDER_BASE_URL=https://api.z.ai/api/anthropic
      - SONNET_PROVIDER_API_KEY=f588d31a2a6f4869a0297509da6d42ab.YwwL3W8HRUxLNjIk
      - SONNET_PROVIDER_BASE_URL=https://api.z.ai/api/anthropic
      - GLM_HAIKU_MODEL=glm-4.7
      - GLM_SONNET_MODEL=glm-4.7
      - ANTHROPIC_DEFAULT_HAIKU_MODEL=glm-4.7
      - ANTHROPIC_DEFAULT_SONNET_MODEL=glm-4.7
    volumes:
      - proxy-config:/app/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - claude-network

  # ============================================
  # CLAWDBOT (The Agent)
  # ============================================
  clawdbot:
    build:
      context: ./clawdbot
      dockerfile: Dockerfile
    container_name: clawdbot
    restart: unless-stopped
    depends_on:
      proxy:
        condition: service_healthy
    environment:
      - ANTHROPIC_BASE_URL=http://proxy:8082
      - ANTHROPIC_API_KEY=placeholder
      - GH_TOKEN=${GH_TOKEN}
      - CLAUDE_DEFAULT_MODEL=claude-haiku-4-20250514
    volumes:
      - claude-auth:/root/.claude
      - ./clawdbot/prompts:/prompts:ro
      - ./clawdbot/settings.json:/root/.claude/settings.json:ro
      - workspace:/workspace
    stdin_open: true
    tty: true
    working_dir: /workspace
    networks:
      - claude-network

  # ============================================
  # SCHEDULER (Cron Jobs)
  # ============================================
  scheduler:
    image: mcuadros/ofelia:latest
    container_name: scheduler
    restart: unless-stopped
    depends_on:
      - clawdbot
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./clawdbot/tasks/cron.ini:/etc/ofelia/config.ini:ro
    command: daemon --docker
    networks:
      - claude-network

  # ============================================
  # TELEGRAM BOT (Mobile Interface)
  # ============================================
  telegram-bot:
    build:
      context: ./clawdbot/bot
      dockerfile: Dockerfile
    container_name: clawdbot-telegram
    restart: unless-stopped
    depends_on:
      - clawdbot
    environment:
      - TELEGRAM_BOT_TOKEN=8558008669:AAFPdgQ0-9snUSjbsjrvvjP00mw7lUIIV5Y
      - CLAWDBOT_URL=http://clawdbot:8082
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - workspace:/workspace:ro
    networks:
      - claude-network

# ============================================================
# VOLUMES - Persistent Data Storage
# ============================================================
volumes:
  proxy-config:
    name: proxy-config
  claude-auth:
    name: claude-auth
  workspace:
    name: workspace

# ============================================================
# NETWORKS
# ============================================================
networks:
  claude-network:
    name: claude-network
    driver: bridge
